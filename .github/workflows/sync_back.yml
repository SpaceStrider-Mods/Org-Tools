name: Sync Public â†’ Private (Merged PRs)

on:
  workflow_call:
    secrets:
      ORG_SYNC_PAT:
        required: true

jobs:
  sync_back:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Derive private repo name
        id: names
        run: |
          PUBLIC_REPO="${{ github.event.repository.name }}"
          PRIVATE_REPO="${PUBLIC_REPO%_Public}"
          echo "PRIVATE_REPO=${PRIVATE_REPO}" >> $GITHUB_ENV
          echo "Syncing merged PR to ${PRIVATE_REPO}"

      - name: Checkout merged PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Push to private repo
        env:
          PAT: ${{ secrets.ORG_SYNC_PAT }}
        run: |
          BRANCH_NAME="community_merge_${{ github.event.pull_request.number }}"

          git config user.name "Mirror Bot"
          git config user.email "mirror@space-strider-mods.com"

          git remote add private https://x-access-token:${PAT}@github.com/${{ github.repository_owner }}/${PRIVATE_REPO}.git
          git fetch private
          git push private HEAD:refs/heads/${BRANCH_NAME}
